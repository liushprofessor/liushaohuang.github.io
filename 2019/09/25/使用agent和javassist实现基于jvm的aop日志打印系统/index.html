<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="简介java在JDK1.5中提供了java.lang.Instrument包,该包提供了一些工具帮助开发人员在 Java 程序运行时动态的修改class,此文介绍其中的agent组件来实现基于jvm层面的aop.">
<meta name="keywords" content="javassist,agent,instrument">
<meta property="og:type" content="article">
<meta property="og:title" content="使用agent和javassist实现基于jvm的aop日志打印系统">
<meta property="og:url" content="http://www.liushaohuang.cn/2019/09/25/使用agent和javassist实现基于jvm的aop日志打印系统/index.html">
<meta property="og:site_name" content="刘绍煌">
<meta property="og:description" content="简介java在JDK1.5中提供了java.lang.Instrument包,该包提供了一些工具帮助开发人员在 Java 程序运行时动态的修改class,此文介绍其中的agent组件来实现基于jvm层面的aop.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-27T09:17:33.295Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用agent和javassist实现基于jvm的aop日志打印系统">
<meta name="twitter:description" content="简介java在JDK1.5中提供了java.lang.Instrument包,该包提供了一些工具帮助开发人员在 Java 程序运行时动态的修改class,此文介绍其中的agent组件来实现基于jvm层面的aop.">
  <link rel="canonical" href="http://www.liushaohuang.cn/2019/09/25/使用agent和javassist实现基于jvm的aop日志打印系统/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>使用agent和javassist实现基于jvm的aop日志打印系统 | 刘绍煌</title>
  <meta name="generator" content="Hexo 3.9.0">
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">刘绍煌</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://www.liushaohuang.cn/2019/09/25/使用agent和javassist实现基于jvm的aop日志打印系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘绍煌">
      <meta itemprop="description" content="刘绍煌的个人博客">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘绍煌">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">使用agent和javassist实现基于jvm的aop日志打印系统

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-25 09:35:04" itemprop="dateCreated datePublished" datetime="2019-09-25T09:35:04+08:00">2019-09-25</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-27 17:17:33" itemprop="dateModified" datetime="2019-09-27T17:17:33+08:00">2019-09-27</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>java在JDK1.5中提供了java.lang.Instrument包,该包提供了一些工具帮助开发人员在 Java 程序运行时动态的修改class,此文介绍其中的agent组件来实现基于jvm层面的aop.</p>
<a id="more"></a>

<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><p>如果我们在cmd输入java -help就会看到关于javaagent命令的简介</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java -help</span><br><span class="line">用法: java [-options] class [args...]</span><br><span class="line"></span><br><span class="line">其中选项包括:</span><br><span class="line"></span><br><span class="line">   -javaagent:&lt;jarpath&gt;[=&lt;选项&gt;]</span><br><span class="line">                 加载 Java 编程语言代理, 请参阅 java.lang.instrument</span><br></pre></td></tr></table></figure>

<p>实例如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/to/agent.jar -jar /main.jar</span><br></pre></td></tr></table></figure>

<p><strong>其中javaagent参数后的路径就是我们要编写的代码,其可以在要代理运行的jar运行前进行一些class字节的操作,如果在此期间使用犹如javassist,或者asm字节码操作的框架则可以实现在类运行前对要运行的class进行修改.</strong></p>
<h4 id="agent简介"><a href="#agent简介" class="headerlink" title="agent简介"></a>agent简介</h4><ul>
<li>参数 javaagent 可以用于指定一个 jar 包，并且对该 java 包有2个要求：</li>
</ul>
<ol>
<li>这个jar 包的MANIFEST.MF 文件必须指定 Premain-Class 项。  </li>
<li>Premain-Class 指定的那个类必须实现 premain（）方法。<br>关于第一点我们在后续创建工程中使用maven 打包插件maven-assembly-plugin去解决这一点.<br>现在我们解释一下第二点:<br>javaagent程序不需要实现任何接口,只需要创建一个类其中类中必须要有以下方法之一即可</li>
</ol>
<p>public static void premain(String agentArgs, Instrumentation inst)<br>public static void premain(String agentArgs)  </p>
<p>一般我们使用第一个方法 ,参数 agentArgs 时通过命令行传给 Java Agent 的参数，inst 是Java Class 字节码转换的工具，Instrumentation 常用方法如下：  </p>
<p>void addTransformer(ClassFileTransformer transformer, boolean canRetransform);<br>增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换<strong>我们可以使用ClassFileTransformer对象结合javassist或者asm对class文件进行修改</strong>。</p>
<p>void redefineClasses(ClassDefinition… definitions) hrows ClassNotFoundException, UnmodifiableClassException;<br>在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。</p>
<p>本文中我们使用addTransformer方法在class文件加载前,我们对class字节码进行处理,添加打印日志代码,此方法接收一个ClassFileTransformer对象,Transformer 类包含了一个 transform 方法，它的签名会接受 ClassLoader、类名、要重定义的类所对应的 Class 对象、定义权限的 ProtectionDomain 以及这个类的原始字节。<strong>如果从 transform 方法中返回 null 的话，将会告诉运行时环境我们并没有对这个类进行变更。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line">                return new byte[0];</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现思路简介"><a href="#实现思路简介" class="headerlink" title="实现思路简介"></a>实现思路简介</h4><p>我们实现的原理很简单,首先我们在运行的主工程中定义个注解,此注解的功能是标识出哪些方法和哪些参数需要打印log,其作用域为在方法上,fields属性为数组,我们将需要打印的参数的角标放入其中如,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//打印方法的第一个参数</span><br><span class="line">@PrintLog(fields = &#123;&quot;1&quot;&#125;)</span><br><span class="line">    public void test(String name,String name2)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface PrintLog &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String[] fields();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们对需要打印日志的方法如上加上注解即可,在运行agent程序的时候我们会在class文件加载前,逐个扫描方法,查看是否有@PrintLog注解,如果有注解我们则应用javassist框架在class文件中加入打印代码,由于在之前文章讲述的类加载器的双亲委派模型,同一个class文件在双亲委派模式下只会加载一次,所以只有在class文件第一次被加载时才会触发此修改class的条件,因此也不必过多担心效率问题.</p>
<h4 id="搭建agent工程"><a href="#搭建agent工程" class="headerlink" title="搭建agent工程"></a>搭建agent工程</h4><h5 id="创建agent主题类"><a href="#创建agent主题类" class="headerlink" title="创建agent主题类"></a>创建agent主题类</h5><p>我们新建一个maven工程,首先新建一个类,其只包含上文简介的premain方法,并添加一个日志打印转换器,此方法会在代码里jar文件执行main方法前执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description  自定义agent在main方法执行前执行</span><br><span class="line"> * @date 2019/9/23 15:32</span><br><span class="line"> **/</span><br><span class="line">public class MyAgent &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void premain(String agentArgs, Instrumentation inst) &#123;</span><br><span class="line"></span><br><span class="line">        inst.addTransformer(new LogPrintTransformer());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建ClassFileTransformer转换类"><a href="#创建ClassFileTransformer转换类" class="headerlink" title="创建ClassFileTransformer转换类"></a>创建ClassFileTransformer转换类</h5><p>上文提到premain方法中有一个Instrumentation对象,其的addTransformer方法可以添加一个创建ClassFileTransformer转换类,其可以在class第一次加载时对class文件进行处理,修改java代码因此我们现在创建一个ClassFileTransformer的实现类,类中主要使用javassist框架扫描加载的类的信息,和方法,查看方法上时候有我们之前标识的@PrintLog注解,如果有的话获取注解中的值,然后最后根据获取的值打印对应的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">import javassist.*;</span><br><span class="line">import javassist.bytecode.AnnotationsAttribute;</span><br><span class="line">import javassist.bytecode.CodeAttribute;</span><br><span class="line">import javassist.bytecode.LocalVariableAttribute;</span><br><span class="line">import javassist.bytecode.MethodInfo;</span><br><span class="line"></span><br><span class="line">import javassist.bytecode.annotation.Annotation;</span><br><span class="line">import javassist.bytecode.annotation.ArrayMemberValue;</span><br><span class="line">import javassist.bytecode.annotation.MemberValue;</span><br><span class="line">import javassist.bytecode.annotation.StringMemberValue;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.lang.instrument.IllegalClassFormatException;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description</span><br><span class="line"> * @date 2019/9/23 15:41</span><br><span class="line"> **/</span><br><span class="line">public class LogPrintTransformer implements ClassFileTransformer &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 签名会接受 ClassLoader、类名、要重定义的类所对应的 Class 对象、定义权限的 ProtectionDomain 以及这个类的原始字节。</span><br><span class="line">     * 如果从 transform 方法中返回 null 的话，将会告诉运行时环境我们并没有对这个类进行变更。</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            CtClass ctClass=ClassPool.getDefault().get(className.replaceAll(&quot;/&quot;, &quot;.&quot;));</span><br><span class="line">            CtMethod[] ctMethods =ctClass.getDeclaredMethods();</span><br><span class="line">            for(CtMethod ctMethod:ctMethods)&#123;</span><br><span class="line">                if(getAnnotation(ctMethod)!=null) &#123;</span><br><span class="line">                    List&lt;String&gt; value = getParamIndexes(getAnnotation(ctMethod));</span><br><span class="line">                    ctMethod.insertBefore(createJavaString(className, ctMethod, value));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return ctClass.toBytecode();</span><br><span class="line">        &#125; catch (NotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (CannotCompileException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //在javassist中$1代表方法的第一个参数,$2代表第二个参数以此类推可参考https://www.jianshu.com/p/b9b3ff0e1bf8</span><br><span class="line">    private String createJavaString(String className,CtMethod ctMethod,List&lt;String&gt; params)&#123;</span><br><span class="line">        StringBuilder stringBuilder=new StringBuilder();</span><br><span class="line">        for(String index:params)&#123;</span><br><span class="line">            stringBuilder.append(&quot;System.out.println($&quot;);</span><br><span class="line">            stringBuilder.append(index);</span><br><span class="line">            stringBuilder.append(&quot;);&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //查找方法注解</span><br><span class="line">    public    Annotation getAnnotation(CtMethod method) &#123;</span><br><span class="line">        MethodInfo methodInfo = method.getMethodInfo();</span><br><span class="line">        AnnotationsAttribute attInfo = (AnnotationsAttribute) methodInfo</span><br><span class="line">                .getAttribute(AnnotationsAttribute.visibleTag);</span><br><span class="line">        if (attInfo != null) &#123;</span><br><span class="line">            return attInfo.getAnnotation(&quot;com.liu.PrintLog&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //获得注解中的属性值</span><br><span class="line">    public  List&lt;String&gt; getParamIndexes(Annotation annotation) &#123;</span><br><span class="line">        ArrayMemberValue fields =</span><br><span class="line">                (ArrayMemberValue) annotation.getMemberValue(&quot;fields&quot;);</span><br><span class="line">        if (fields != null) &#123;</span><br><span class="line">            MemberValue[] values = fields.getValue();</span><br><span class="line">            List&lt;String&gt; parameterIndexes = new ArrayList&lt;&gt;();</span><br><span class="line">            for (MemberValue val : values) &#123;</span><br><span class="line">                parameterIndexes.add(((StringMemberValue) val).getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            return parameterIndexes;</span><br><span class="line">        &#125;</span><br><span class="line">        return Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="生成MANIFEST-MF文件"><a href="#生成MANIFEST-MF文件" class="headerlink" title="生成MANIFEST.MF文件"></a>生成MANIFEST.MF文件</h5><p>使用agent必须在MANIFEST.MF中指定Premain-Class表示我们只想的agent的类,设置Can-Redefine-Classes和Can-Retransform-Classes属性为true,我们采用maven插件的方式进行打包,由maven自动生成MANIFEST.MF文件<br>在maven pom依赖中加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- http://maven.apache.org/shared/maven-archiver/index.html#class_manifest --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.2&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;descriptorRefs&gt;</span><br><span class="line">                        &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                    &lt;/descriptorRefs&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;index&gt;true&lt;/index&gt;</span><br><span class="line">                        &lt;manifestEntries&gt;</span><br><span class="line">                        &lt;!-- 设置MANIFEST中的属性 --&gt;</span><br><span class="line">                            &lt;Premain-Class&gt;com.liu.MyAgent&lt;/Premain-Class&gt;</span><br><span class="line">                            &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;</span><br><span class="line">                            &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt;</span><br><span class="line">                        &lt;/manifestEntries&gt;</span><br><span class="line">                    &lt;/archive&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">                        &lt;!-- 将插件绑定maven的package命令--&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;!-- append to the packaging phase. --&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                            &lt;!-- goals == mojos --&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br></pre></td></tr></table></figure>

<h4 id="创建主工程"><a href="#创建主工程" class="headerlink" title="创建主工程"></a>创建主工程</h4><h5 id="创建打印注解"><a href="#创建打印注解" class="headerlink" title="创建打印注解"></a>创建打印注解</h5><p>此类为了标识哪些方法的哪些参数需要打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface PrintLog &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String[] fields();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个测试类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description</span><br><span class="line"> * @date 2019/9/23 18:12</span><br><span class="line"> **/</span><br><span class="line">public class LogTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @PrintLog(fields = &#123;&quot;1&quot;&#125;)</span><br><span class="line">    public void test(String name,String name2)&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;over...........................&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建main方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description</span><br><span class="line"> * @date 2019/9/23 18:06</span><br><span class="line"> **/</span><br><span class="line">public class MainTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">			LogTest logTest=new LogTest();</span><br><span class="line">			logTest.test(&quot;liushaohuang111&quot;,&quot;liushaohuang2222&quot;);</span><br><span class="line"></span><br><span class="line">    		&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样我是使用maven maven-assembly-plugin插件进行打包,与上面不同的是我们这次不要指定Premain-Class,Can-Redefine-Classes和Can-Retransform-Classes参数我们只需要声明main函数的入口即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- http://maven.apache.org/shared/maven-archiver/index.html#class_manifest --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.2&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;descriptorRefs&gt;</span><br><span class="line">                        &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                    &lt;/descriptorRefs&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;index&gt;true&lt;/index&gt;</span><br><span class="line">                        &lt;manifest&gt;</span><br><span class="line">                            &lt;mainClass&gt;com.liu.MainTest&lt;/mainClass&gt;</span><br><span class="line">                        &lt;/manifest&gt;</span><br><span class="line">                    &lt;/archive&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">                        &lt;!-- this is used for inheritance merges --&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;!-- append to the packaging phase. --&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                            &lt;!-- goals == mojos --&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br></pre></td></tr></table></figure>

<h4 id="打包运行"><a href="#打包运行" class="headerlink" title="打包运行"></a>打包运行</h4><p>在两个工程目录下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<p>运行javaagent命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:.\agent-1.0-SNAPSHOT-jar-with-dependencies.jar -jar .\main_test-1.0-SNAPSHOT-jar-with-dependencies.jar</span><br></pre></td></tr></table></figure>

<p>在控制台中出现,成功打印出传入的第一个参数,并且在原始方法执行打印overing之前执行打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">liushaohuang111</span><br><span class="line">over...........................</span><br></pre></td></tr></table></figure>

<h4 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h4><p><strong>在实践中本人思考premain 中的Instrumentation  添加的转换器到底什么时候才起作用呢？这里再做一个实践，我们修改premain方法，往里面加入一行打印代码，为了方便在运行的时候发现什么时候触发转化器,其余代码和之前的代码一模一样</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">import javassist.*;</span><br><span class="line">import javassist.bytecode.AnnotationsAttribute;</span><br><span class="line">import javassist.bytecode.CodeAttribute;</span><br><span class="line">import javassist.bytecode.LocalVariableAttribute;</span><br><span class="line">import javassist.bytecode.MethodInfo;</span><br><span class="line"></span><br><span class="line">import javassist.bytecode.annotation.Annotation;</span><br><span class="line">import javassist.bytecode.annotation.ArrayMemberValue;</span><br><span class="line">import javassist.bytecode.annotation.MemberValue;</span><br><span class="line">import javassist.bytecode.annotation.StringMemberValue;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.lang.instrument.IllegalClassFormatException;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description</span><br><span class="line"> * @date 2019/9/23 15:41</span><br><span class="line"> **/</span><br><span class="line">public class LogPrintTransformer implements ClassFileTransformer &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 签名会接受 ClassLoader、类名、要重定义的类所对应的 Class 对象、定义权限的 ProtectionDomain 以及这个类的原始字节。</span><br><span class="line">     * 如果从 transform 方法中返回 null 的话，将会告诉运行时环境我们并没有对这个类进行变更。</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;in transform....................&quot;);</span><br><span class="line">            CtClass ctClass=ClassPool.getDefault().get(className.replaceAll(&quot;/&quot;, &quot;.&quot;));</span><br><span class="line">            CtMethod[] ctMethods =ctClass.getDeclaredMethods();</span><br><span class="line">            for(CtMethod ctMethod:ctMethods)&#123;</span><br><span class="line">                if(getAnnotation(ctMethod)!=null) &#123;</span><br><span class="line">                    List&lt;String&gt; value = getParamIndexes(getAnnotation(ctMethod));</span><br><span class="line">                    ctMethod.insertBefore(createJavaString(className, ctMethod, value));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return ctClass.toBytecode();</span><br><span class="line">        &#125; catch (NotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (CannotCompileException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //在javassist中$1代表方法的第一个参数,$2代表第二个参数以此类推可参考https://www.jianshu.com/p/b9b3ff0e1bf8</span><br><span class="line">    private String createJavaString(String className,CtMethod ctMethod,List&lt;String&gt; params)&#123;</span><br><span class="line">        StringBuilder stringBuilder=new StringBuilder();</span><br><span class="line">        for(String index:params)&#123;</span><br><span class="line">            stringBuilder.append(&quot;System.out.println($&quot;);</span><br><span class="line">            stringBuilder.append(index);</span><br><span class="line">            stringBuilder.append(&quot;);&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //查找方法注解</span><br><span class="line">    public    Annotation getAnnotation(CtMethod method) &#123;</span><br><span class="line">        MethodInfo methodInfo = method.getMethodInfo();</span><br><span class="line">        AnnotationsAttribute attInfo = (AnnotationsAttribute) methodInfo</span><br><span class="line">                .getAttribute(AnnotationsAttribute.visibleTag);</span><br><span class="line">        if (attInfo != null) &#123;</span><br><span class="line">            return attInfo.getAnnotation(&quot;com.liu.PrintLog&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //获得注解中的属性值</span><br><span class="line">    public  List&lt;String&gt; getParamIndexes(Annotation annotation) &#123;</span><br><span class="line">        ArrayMemberValue fields =</span><br><span class="line">                (ArrayMemberValue) annotation.getMemberValue(&quot;fields&quot;);</span><br><span class="line">        if (fields != null) &#123;</span><br><span class="line">            MemberValue[] values = fields.getValue();</span><br><span class="line">            List&lt;String&gt; parameterIndexes = new ArrayList&lt;&gt;();</span><br><span class="line">            for (MemberValue val : values) &#123;</span><br><span class="line">                parameterIndexes.add(((StringMemberValue) val).getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            return parameterIndexes;</span><br><span class="line">        &#125;</span><br><span class="line">        return Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们更改主项目中被代理的main方法代码,里面一共new了4次LogTest对象</p>
<ol>
<li>第一个是第一次触发class加载(class文件只有被调用时候才会第一次加载到虚拟机)，则会触发premain方法中的转换器</li>
<li>第二个是直接调用堆栈中的class又new一次对象对象，没有触发转化器</li>
<li>第三个我们使用自定义类加载器，并且不突破双亲委派模式(还是调用堆栈中的LogTest)，同样也没有触发转化器</li>
<li>第四个，我们又创建了一个类加载器，并且突破双亲委派模式，重新加载一个LogTest，不再使用之前堆栈中的LogTest对象，最后发现触发了转化器</li>
</ol>
<p><strong>结论：只有在class重新被加载时才会触发ClassFileTransformer转换器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">package com.liu;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Liush</span><br><span class="line"> * @description</span><br><span class="line"> * @date 2019/9/23 18:06</span><br><span class="line"> **/</span><br><span class="line">public class MainTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line"></span><br><span class="line">        //第一次次加载触发ClassFileTransformer</span><br><span class="line">        LogTest logTest = new LogTest();</span><br><span class="line">        logTest.test(&quot;liushaohuang111&quot;, &quot;liushaohuang2222&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //重新创建对象,不会触发premain中的ClassFileTransformer(类已经加载到堆栈中)</span><br><span class="line">        LogTest logTest1 = new LogTest();</span><br><span class="line">        logTest1.test(&quot;shao111111111111&quot;, &quot;shao22222222222222&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //不突破双亲委派类进行类加载,不会触发premain中的ClassFileTransformer(类已经加载到堆栈中)</span><br><span class="line">        ClassLoader classLoader = new ClassLoader() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    String fileName = name.substring(name.lastIndexOf(&quot;.&quot;) + 1) + &quot;.class&quot;;</span><br><span class="line">                    InputStream is = getClass().getResourceAsStream(fileName);</span><br><span class="line">                    if (is == null) &#123;</span><br><span class="line">                        return super.loadClass(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    byte[] b = new byte[is.available()];</span><br><span class="line">                    is.read(b);</span><br><span class="line">                    return defineClass(name, b, 0, b.length);</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    throw new ClassNotFoundException(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Class aClass = classLoader.loadClass(&quot;com.liu.LogTest&quot;);</span><br><span class="line">        LogTest logTest2 = (LogTest)aClass.newInstance();</span><br><span class="line">        logTest2.test(&quot;Parents Delegation Model 1&quot;,&quot;Parents Delegation Model 2&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //突破双亲委派模式</span><br><span class="line">        ClassLoader classLoader2=new ClassLoader() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    String fileName = name.substring(name.lastIndexOf(&quot;.&quot;) + 1) + &quot;.class&quot;;</span><br><span class="line">                    InputStream is = getClass().getResourceAsStream(fileName);</span><br><span class="line">                    if (is == null) &#123;</span><br><span class="line">                        return super.loadClass(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    byte[] b = new byte[is.available()];</span><br><span class="line">                    is.read(b);</span><br><span class="line">                    return defineClass(name, b, 0, b.length);</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    throw new ClassNotFoundException(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Class aClass2 = classLoader.loadClass(&quot;com.liu.LogTest&quot;);</span><br><span class="line">        LogTest logTest3 = (LogTest)aClass.newInstance();</span><br><span class="line">        logTest3.test(&quot;No Parents Delegation Model1&quot;,&quot;No Parents Delegation Model 2&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br><span class="line">liushaohuang111</span><br><span class="line">over...........................</span><br><span class="line">shao111111111111</span><br><span class="line">over...........................</span><br><span class="line">Parents Delegation Model 1</span><br><span class="line">over...........................</span><br><span class="line">in transform....................</span><br><span class="line">No Parents Delegation Model1</span><br><span class="line">over...........................</span><br><span class="line">in transform....................</span><br><span class="line">in transform....................</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        
      
        <div id="reward-container">
  <div></div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
        
      
      <div style="display: inline-block">
        <img src="/images/赞赏码.png" alt="刘绍煌 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/javassist/" rel="tag"># javassist</a>
            
              <a href="/tags/agent/" rel="tag"># agent</a>
            
              <a href="/tags/instrument/" rel="tag"># instrument</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/09/24/mysql存储过程游标的嵌套和使用/" rel="next" title="mysql存储过程游标的嵌套和使用(统计局地区维度表的创建)">
                  <i class="fa fa-chevron-left"></i> mysql存储过程游标的嵌套和使用(统计局地区维度表的创建)
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/09/26/使用agentmain进行运行时热部署/" rel="prev" title="使用agentmain进行运行时热部署">
                  使用agentmain进行运行时热部署 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#命令"><span class="nav-number">2.</span> <span class="nav-text">命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#agent简介"><span class="nav-number">3.</span> <span class="nav-text">agent简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现思路简介"><span class="nav-number">4.</span> <span class="nav-text">实现思路简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#搭建agent工程"><span class="nav-number">5.</span> <span class="nav-text">搭建agent工程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建agent主题类"><span class="nav-number">5.1.</span> <span class="nav-text">创建agent主题类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建ClassFileTransformer转换类"><span class="nav-number">5.2.</span> <span class="nav-text">创建ClassFileTransformer转换类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#生成MANIFEST-MF文件"><span class="nav-number">5.3.</span> <span class="nav-text">生成MANIFEST.MF文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建主工程"><span class="nav-number">6.</span> <span class="nav-text">创建主工程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建打印注解"><span class="nav-number">6.1.</span> <span class="nav-text">创建打印注解</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打包运行"><span class="nav-number">7.</span> <span class="nav-text">打包运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更进一步"><span class="nav-number">8.</span> <span class="nav-text">更进一步</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">刘绍煌</p>
  <div class="site-description" itemprop="description">刘绍煌的个人博客</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘绍煌</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.3.0</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.3.0"></script><script src="/js/motion.js?v=7.3.0"></script>
<script src="/js/schemes/pisces.js?v=7.3.0"></script>
<script src="/js/next-boot.js?v=7.3.0"></script>



  





















  

  

  

</body>
</html>
